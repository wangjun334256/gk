<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>成绩趋势</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0px;
            font-family: Arial, sans-serif;
            font-size: 0.5rem;
            background-color: #e3e3dfba;
        }
        /* 表格整体样式 */
        table {
            width: 100%;
            border-collapse: collapse; /* 合并边框 */
        }

        th, td {
            padding: 8px;
            text-align: left;
        }
        .part1 {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
        }
        .part2 {
            position: absolute;
            left: 50%;
            top:450px;
            transform: translateX(-50%);
            width: 95%;
            height: 400px;
            font-size: 10px;
        }
        h1 {
            font-size: 1.5rem;
            text-align: center;
        }
        #chart {
            width: 100%;
            max-width: 600px;
            height: 300px;
            margin: 0 auto;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            gap: 5px;
            margin-bottom: 20px;
        }
        .button-group button {
            padding: 2px 10px;
            font-size: 0.5rem;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .button-group button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .rank-buttons {
            position: fixed;
            top: 100px;
            right: -5px;
            display: flex;
            gap: 10px;
            flex-direction: column;
        }
        .rank-button {
            font-size: 0.5rem;
            cursor: pointer;
            background-color: #244c2db3;
            color: white;
            border: none;
            border-radius: 4px;
            width: 23px;
        }
        .rank-button:hover {
            background-color: #218838;
        }
        .rank-buttons .active {
            background-color: #218838;
            color: white;
            border-color: #007bff;
        }

        .student-button-group {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .student-button-group button {
            padding: 2px 10px;
            font-size: 0.5rem;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .student-button-group .active {
            background-color: #218838;
            color: white;
            border-color: #007bff;
        }


        .tab-content {

        }
        .tab-content {
           display: none;
        }
        .tab-content.active {
            display: block;

        }
        .ndBtnGroup {
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .ndBtnGroup button {
            margin: 0 1px;
            font-size: 0.6rem;
        }
        .ndBtnGroup button.active{
            color: white;
            background-color: #007bff;
            border-color: #007bff;
        }

        .thead {
            /*line-height: 25px;*/
            background-color: #007bff;
        }

        .part2BtnGroup {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
            position: absolute;
            top: 11px;
            left: 170px;
        }

        .table {
            border: 1px solid #007bff;
        }

        /* Tab 按钮样式 */
        .tab-buttons {
            display: flex;
            gap: 5px;
        }

        .tab-button {
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px 4px 0 0;
            border-bottom: none;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background-color: #e0e0e0;
        }

        .tab-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            border-bottom: 1px solid #007bff;
        }

        /* Tab 内容区域样式 */
        .tab-content {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 0 4px 4px 4px;
            background-color: #dee7f9;
        }

        .tab-content.active {
            display: block;
        }


        /*筛选提条件样式start*/
        .filterCriteria {
            /*position: absolute;*/
            margin-bottom: 10px;
        }

        .filter-input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }

        .filter-input-group input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.5rem;
            width: 120px;
        }

        .filter-input-group input:focus {
            border-color: #007bff;
            outline: none;
        }

        .filter-input-group button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.5rem;
        }

        .filter-input-group button:hover {
            background-color: #0056b3;
        }
        /*筛选提条件样式end*/

        /*AI对话框样式start*/
        #deepseek-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 400px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 0.6rem;
            line-height: 1.8;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            opacity: 0;
        }
        #chat-header {
            padding: 10px;
            background-color: #007bff;
            color: white;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            font-weight: bold;
            text-align: center;
        }
        #chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }
        #chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ccc;
        }
        #user-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #sendButton {
            margin-left: 10px;
            padding: 8px 16px;
            background-color: #8f8f8f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            max-width: 80%;
        }
        .user-message {
            background-color: #e3f2fd;
            margin-left: auto;
        }
        .bot-message {
            background-color: #f1f1f1;
            margin-right: auto;
        }
        .closeAsk {
            position: absolute;
            top: 6px;
            right: 6px;
            font-size: 15px;
            cursor: pointer;
            color: #d0d5db;
        }
        .closeAsk:hover  {
            color: #ff1a1a;
        }
        .apiKeyContent {
            position: absolute;
            top: -21px;
            left: 0px;
            color: red;
        }
        /*AI对话框样式end*/

        #loadingIndicator {
            text-align: center;
            position: absolute;
            top: 41%;
            left: 50%;
            transform: translateX(-50%);
        }

        /* 加载动画样式 */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #007bff;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>


    <!--AI对话框-->
    <div id="deepseek-chat">
        <div class="apiKeyContent">
            <label for="inputapiKey">API Key:</label>
            <input style="border:0;border-bottom: 1px solid #292626;" type="text" id="inputapiKey" placeholder="">
        </div>
        <div id="chat-header">DeepSeek 问询窗口</div>
        <!-- 等待提示动效 -->
        <div id="loadingIndicatorAI" style="display: none;margin-top: 10px;text-align: center;">
            <div class="spinner"></div>
            <span>正在导入，请稍候...</span>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input">
            <input type="text" id="user-input" placeholder="输入问题...">
            <button id="sendButton">发送</button>
        </div>
        <div class="closeAsk" onclick="closeAIask()">X</div>></div>
    </div>
    <!--AI对话 js-->
    <script>

        // 获取输入框和按钮元素
        const apiKeyInput = document.getElementById('inputapiKey');
        const sendButton = document.getElementById('sendButton');

        // 监听输入框的变化
        apiKeyInput.addEventListener('input', function() {
            if (apiKeyInput.value.trim() === '') {
                // 如果输入框为空，禁用按钮
                document.getElementById('sendButton').style.backgroundColor = '#8f8f8f';
            } else {
                // 如果输入框有值，启用按钮
                document.getElementById('sendButton').style.backgroundColor = '#007bff';
            }
        });


        // 初始化对话历史
        // let chatHistory = JSON.parse(localStorage.getItem('deepseekChatHistory')) || [];
        let chatHistory = [];
        const MAX_HISTORY_LENGTH = 10; // 限制最多存储 10 条对话记录

        // 加载历史对话
        function loadChatHistory() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            chatHistory.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender}-message`;
                messageDiv.textContent = msg.text;
                chatMessages.appendChild(messageDiv);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 保存对话到本地存储（限制条数）
        function saveChatHistory() {
            // 如果超过最大限制，移除最早的记录
            if (chatHistory.length > MAX_HISTORY_LENGTH) {
                chatHistory = chatHistory.slice(chatHistory.length - MAX_HISTORY_LENGTH);
            }
            localStorage.setItem('deepseekChatHistory', JSON.stringify(chatHistory));
        }

        // 调用 DeepSeek API
        async function getDeepSeekResponse(userInput) {
            const API_KEY = document.getElementById('inputapiKey').value;//'sk-c1c15ed0533b446fbbde841c40627ba3'; // 替换为你的 API 密钥
            const API_URL = 'https://api.deepseek.com/v1/chat/completions'; // 替换为实际的 API 地址
            // const modelName = 'deepseek-chat';
            const modelName = 'deepseek-reasoner';
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: modelName, // 根据 API 文档填写模型名称
                        messages: [
                            ...chatHistory.map(msg => ({
                                role: msg.sender === 'user' ? 'user' : 'assistant',
                                content: msg.text
                            })),
                            { role: 'user', content: userInput }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API 请求失败: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content; // 根据 API 返回结构调整
            } catch (error) {
                console.error('调用 DeepSeek API 出错:', error);
                return '抱歉，暂时无法获取回答。';
            }
        }

        // 调用qianw3 API
        async function getQianw3Response(userInput) {
            const API_KEY = document.getElementById('inputapiKey').value; // 替换为你的 qianw3 API Key
            const API_URL = 'https://qianwen-api.example.com/chat/completions'; // 替换为 qianw3 的实际 API 地址
            const modelName = 'qianw3-model'; // 替换为 qianw3 支持的模型名称

            // 2. 构造 API 请求参数
/*            const requestData = {
                model: "ERNIE-Bot-4", // 千问模型名称（如 qianwen-v1 等，根据实际模型填写）
                messages: conversationHistory, // 传递完整对话历史
                temperature: 0.7, // 随机性（0-1，值越高回复越多样）
                max_tokens: 1024 // 最大回复长度
            };*/

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}` // 根据 qianw3 的认证方式调整
                    },
                    body: JSON.stringify({
                        model: modelName, // qianw3 的模型名称
                        messages: [
                            ...chatHistory.map(msg => ({
                                role: msg.sender === 'user' ? 'user' : 'assistant',
                                content: msg.text
                            })),
                            { role: 'user', content: userInput }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API 请求失败: ${response.status} - ${errorData.error?.message || '未知错误'}`);
                }

                const data = await response.json();
                return data.choices[0].message.content; // 根据 qianw3 的响应结构调整
            } catch (error) {
                console.error('调用 qianw3 API 出错:', error);
                return '抱歉，暂时无法获取回答。';
            }
        }

        // 处理用户输入
        document.getElementById('sendButton').addEventListener('click', async function() {
            const inputapiKey = document.getElementById('inputapiKey').value
            if(!inputapiKey){
                alert('请输入API Key','warning')
                return
            }
            //显示等待动效
            document.getElementById('loadingIndicatorAI').style.display = 'block';

            const userInput = document.getElementById('user-input').value.trim();
            if (userInput) {
                // 添加用户消息
                chatHistory.push({ sender: 'user', text: userInput });
                saveChatHistory();
                loadChatHistory();

                // 调用 DeepSeek API
                // const response = await getQianw3Response(userInput);
                const response = await getDeepSeekResponse(userInput);
                chatHistory.push({ sender: 'bot', text: response });
                saveChatHistory();
                loadChatHistory();

                // 清空输入框
                document.getElementById('user-input').value = '';

                //隐藏等待动效
                document.getElementById('loadingIndicatorAI').style.display = 'none';
            }
        });

        // 初始化加载历史对话
        loadChatHistory();
    </script>


    <div class="part1">
        <h1 class="part1_title">成绩趋势</h1>
        <!--学生按钮组 -->
        <div class="student-button-group"></div>
        <!--科目按钮组-->
        <div class="button-group"></div>
        <!--导入学生成绩Excel按钮-->
        <div class="btnContent">
            <input type="file" id="studentExcelInput" accept=".xlsx, .xls" style="display: none;">
            <button style="font-size: 0.6rem;" onclick="document.getElementById('studentExcelInput').click()">导入成绩Excel</button>
        </div>
        <script>
            document.getElementById('studentExcelInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetNames = workbook.SheetNames;
                    const studentdataMap = {};

                    // 解析所有Sheet
                    sheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                        // 解析Excel数据
                        const newdataMap = { dataList1: [] };

                        // 从第三行开始解析
                        for (let i = 2; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length < 5) continue;

                            const name = row[0];
                            const scoreName = row[1];
                            const scoreValue = row[2];
                            const rankValue = row[3];
                            const rankValue2 = row[4];

                            // 检查是否已存在该name的条目
                            let dataItem1 = newdataMap.dataList1.find(item => item.name === name);
                            if (!dataItem1) {
                                dataItem1 = { name, scoreList: [] };
                                newdataMap.dataList1.push(dataItem1);
                            }

                            dataItem1.scoreList.push({
                                scoreName,
                                scoreValue,
                                rankValue,
                                rankName: '班排',
                                rankValue2,
                                rankName2: '年排'
                            });
                        }

                        studentdataMap[sheetName] = newdataMap;
                    });

                    // 生成学生名称按钮组
                    const studentButtonGroup = document.querySelector('.student-button-group');

                    sheetNames.forEach((sheetName, index) => {
                        const button = document.createElement('button');
                        if (index === 0) {
                            button.classList.add('active');
                        }
                        button.textContent = sheetName;

                        button.addEventListener('click', function() {
                            // 切换科目active状态
                            document.querySelector('.student-button-group').querySelectorAll('button').forEach(button => {
                                button.classList.remove('active');
                                console.log(button.textContent === sheetName);
                                if (button.textContent === sheetName) {
                                    button.classList.add('active');
                                }
                            })

                            // 切换学生数据
                            dataMap = studentdataMap[sheetName];
                            p_studentName = sheetName;
                            //更新页面标题
                            document.querySelector('.part1_title').textContent = sheetName + '成绩趋势';
                            intPage()
                        });
                        studentButtonGroup.appendChild(button);
                    });

                    // 默认加载第一个学生的数据
                    dataMap = studentdataMap[sheetNames[0]];
                    p_studentName = sheetNames[0];
                    //更新页面标题
                    document.querySelector('.part1_title').textContent = sheetNames[0] + '成绩趋势';
                    intPage()
                };
                reader.readAsArrayBuffer(file);
            });
        </script>

        <div class="rank-buttons">
            <button onclick="showRank('年排', this)" class="rank-button active">年排</button>
            <button onclick="showRank('班排', this)" class="rank-button">班排</button>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

        <!--成绩图表-->
        <div id="chart"></div>

    </div>
    <!-- 等待提示动效 -->
    <div id="loadingIndicator" style="display: none; margin-top: 10px; text-align: center;">
        <div class="spinner"></div>
        <span>正在导入，请稍候...</span>
    </div>
    <div class="part2">
        <div class="part2BtnGroup">
            <!--导入学校Excel按钮-->
            <div class="btnContent">
                <input type="file" id="schoolExcelInput" accept=".xlsx, .xls" style="display: none;">
                <button style="font-size: 0.6rem;" onclick="document.getElementById('schoolExcelInput').click()">导学校Excel</button>
            </div>
            <script>
                document.getElementById('schoolExcelInput').addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    // 显示等待提示动效
                    showLoading()

                    //scoreExcelInput
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetNames = workbook.SheetNames;
                        const parsedData = [];

                        // 解析所有 Sheet
                        sheetNames.forEach(sheetName => {
                            const sheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                            // 解析 Excel 数据
                            const schoolList = [];
                            for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (!row || row.length < 10) continue;
                                //nd:年度 schoolName:学校名称 schoolNO:学校编号  value1:批次  value2:科类  value3:专业名称 value4:专业代码  bz:备注 number:人数 minScore:最低分 minLevel:最低分位次

                                schoolList.push({
                                    schoolName: row[0], // 学校名称
                                    schoolNO: row[1], // 学校编号
                                    value1: row[2],  // 批次
                                    value2: row[3],  // 科类
                                    value3: row[4],  // 专业名称
                                    value4: row[5],  // 专业代码
                                    bz: row[6],  // 备注
                                    number: row[7],  // 人数
                                    minScore: row[8],  // 最低分
                                    minLevel: row[9],  // 最低分位次
                                });
                            }

                            // 添加到 parsedData
                            parsedData.push({
                                nd: sheetName, // 年度（假设 Sheet 名称为年度）
                                schoolList: schoolList
                            });
                        });

                        // 替换 dataMap.dataList2
                        dataMap.dataList3 = parsedData;

                        // 调用 fillTabData 更新界面
                        fillTab2Data();
                    };

                    reader.onerror = function() {
                        // 如果导入失败，隐藏等待提示动效并提示错误
                        hidLoading()
                        alert('导入失败，请检查文件格式！');
                    };

                    reader.readAsArrayBuffer(file);
                });
            </script>

            <!--导入一分一段Excel按钮-->
            <div class="btnContent">
                <input type="file" id="scoreExcelInput" accept=".xlsx, .xls" style="display: none;">
                <button style="font-size: 0.6rem;" onclick="document.getElementById('scoreExcelInput').click()">导入一分一段Excel</button>
            </div>
            <script>
                document.getElementById('scoreExcelInput').addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    // 显示等待提示动效
                    showLoading();

                    //scoreExcelInput
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetNames = workbook.SheetNames;
                        const parsedData = [];

                        // 解析所有 Sheet
                        sheetNames.forEach(sheetName => {
                            const sheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                            // 解析 Excel 数据
                            const scoreList = [];
                            for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (!row || row.length < 3) continue;

                                scoreList.push({
                                    value1: row[0], // 科目名称
                                    value2: row[1], // 分数
                                    value3: row[2],  // 排名
                                });
                            }

                            // 添加到 parsedData
                            parsedData.push({
                                nd: sheetName, // 年度（假设 Sheet 名称为年度）
                                scoreList: scoreList
                            });
                        });

                        // 替换 dataMap.dataList2
                        dataMap.dataList2 = parsedData;

                        // 调用 fillTabData 更新界面
                        fillTab1Data();
                    };
                    reader.onerror = function() {
                        // 如果导入失败，隐藏等待提示动效并提示错误
                        hidLoading()
                        alert('导入失败，请检查文件格式！');
                    };

                    reader.readAsArrayBuffer(file);
                });
            </script>
        </div>

        <!--列表tab组  1：一分一段列表  2：学校专业分数列表-->
        <div class="tabs">
            <div class="tab-buttons">
                <button style="font-size: 0.6rem;" class="tab-button active" onclick="showTab('tab2')">学校录取</button>
                <button style="font-size: 0.6rem;" class="tab-button" onclick="showTab('tab1')">一分一段</button>
            </div>

            <div id="tab2" class="tab-content active">
                <div class="ndBtnGroup ndBtnGroup2"></div>
                <div class="filterCriteria">
                    <div class="filter-input-group">
                        <input type="text" id="schoolInput" placeholder="学校">
                        <input type="text" id="majorInput" placeholder="专业">
                        <input type="number" id="minScoreInput" placeholder="最低分">
                        <input type="number" id="maxScoreInput" placeholder="最高分">
                        <input type="number" id="minRankInput" placeholder="最低位次">
                        <input type="number" id="maxRankInput" placeholder="最高位次">
                        <button id="filterButton">查询</button>
                    </div>
                </div>
                <script>
                    document.getElementById('filterButton').addEventListener('click', function() {
                        // 获取输入框的值
                        const school = document.getElementById('schoolInput').value.trim();
                        const major = document.getElementById('majorInput').value.trim();
/*                        const minScore = parseFloat(document.getElementById('minScoreInput').value) || -Infinity;
                        const maxScore = parseFloat(document.getElementById('maxScoreInput').value) || Infinity;
                        const minRank = parseInt(document.getElementById('minRankInput').value) || -Infinity;
                        const maxRank = parseInt(document.getElementById('maxRankInput').value) || Infinity;*/
                        const minScore = document.getElementById('minScoreInput').value;
                        const maxScore = document.getElementById('maxScoreInput').value;
                        const minRank = document.getElementById('minRankInput').value;
                        const maxRank = document.getElementById('maxRankInput').value;
                        //p_nd2;
                        const ndSchoolList = dataMap.dataList3.filter(item => {
                            return item.nd === p_nd2;
                        });
                        console.log("ndSchoolList",ndSchoolList);
                        //const filteredData = dataMap.dataList3.filter(item => {
                        const filteredData = ndSchoolList[0].schoolList.filter(item => {
/*                            return (
                                (school === '' || item.schoolName.toLowerCase().includes(school)) &&
                                (major === '' || item.value3.toLowerCase().includes(major)) &&
                                (minScore === '' || maxScore === '' || (item.minScore >= minScore && item.minScore <= maxScore)) &&
                                (minRank === '' || maxRank === '' || (item.minLevel <= minRank && item.minLevel >= maxRank))
                            );*/
                            return (
                                (school === '' || item.schoolName.toLowerCase().includes(school)) &&
                                (major === '' || item.value3.toLowerCase().includes(major)) &&
                                (minScore === '' || item.minScore >= minScore) &&
                                (maxScore === '' || item.minScore <= maxScore) &&
                                (minRank === '' || item.minLevel <= minRank) &&
                                (maxRank === '' || item.minLevel >= maxRank)
                            );
                        });

                        loadTable2Data(filteredData);
                    });
                </script>

                <table class="table" id="table2">
                    <thead class="thead thead2">
                        <tr>
                            <th>学校名称</th>
                            <th>学校编号</th>
                            <th>专业</th>
                            <th>人数</th>
                            <th>最低分</th>
                            <th>最低分位次</th>
                        </tr>
                    </thead>
                    <tbody class="tbody2">
                        <!-- 动态填充 dataList3 数据 -->
                    </tbody>
                </table>
            </div>
            <div id="tab1" class="tab-content">
                <div class="ndBtnGroup ndBtnGroup1">

                </div>
                <table class="table" id="table1">
                    <thead class="thead thead1">
                    <tr>
                        <th>分数</th>
                        <th>人数</th>
                        <th>累计人数</th>
                    </tr>
                    </thead>
                    <tbody class="tbody1">
                    <!-- 动态填充 dataList2 数据 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        // 页面加载完成后执行 intEcharts 方法
        window.onload = function() {
            intPage();

            fillTab1Data();

            fillTab2Data();
        };

        function intPage(){
            p_type1 = '总赋分';
            p_type2 = '年排';
            //初始化科目按钮
            intBtnGroup();
            //初始化成绩图表
            intEcharts(p_type1,p_type2, '');
        }

        var p_type1 = '总赋分';
        var p_type2 = '年排';
        var p_studentName = ''
        var dataMap = {
            dataList1: [
                {name:'高一上学期10月月考',
                    scoreList:[
                        {scoreName:'总赋分',scoreValue:590,rankValue:6,rankName:'班排',rankValue2:131,rankName2:'年排'},
                        {scoreName:'总分',scoreValue:590,rankValue:6,rankName:'班排',rankValue2:131,rankName2:'年排'},
                        {scoreName:'语文',scoreValue:104,rankValue:5,rankName:'班排',rankValue2:57,rankName2:'年排'},
                        {scoreName:'数学',scoreValue:119,rankValue:17,rankName:'班排',rankValue2:262,rankName2:'年排'},
                        {scoreName:'英语',scoreValue:112.5,rankValue:10,rankName:'班排',rankValue2:130,rankName2:'年排'},
                        {scoreName:'物理',scoreValue:91,rankValue:7,rankName:'班排',rankValue2:104,rankName2:'年排'},
                        {scoreName:'化学',scoreValue:89,rankValue:7,rankName:'班排',rankValue2:120,rankName2:'年排'},
                        {scoreName:'化学赋分',scoreValue:89,rankValue:7,rankName:'班排',rankValue2:120,rankName2:'年排'},
                        {scoreName:'生物',scoreValue:74,rankValue:28,rankName:'班排',rankValue2:399,rankName2:'年排'},
                        {scoreName:'生物赋分',scoreValue:74,rankValue:28,rankName:'班排',rankValue2:399,rankName2:'年排'},
                    ]
                },
                {name:'高一上学期半期考',
                    scoreList:[
                        {scoreName:'总赋分',scoreValue:573,rankValue:4,rankName:'班排',rankValue2:86,rankName2:'年排'},
                        {scoreName:'总分',scoreValue:573,rankValue:4,rankName:'班排',rankValue2:86,rankName2:'年排'},
                        {scoreName:'语文',scoreValue:104,rankValue:10,rankName:'班排',rankValue2:116,rankName2:'年排'},
                        {scoreName:'数学',scoreValue:108,rankValue:19,rankName:'班排',rankValue2:299,rankName2:'年排'},
                        {scoreName:'英语',scoreValue:116.5,rankValue:20,rankName:'班排',rankValue2:135,rankName2:'年排'},
                        {scoreName:'物理',scoreValue:80,rankValue:7,rankName:'班排',rankValue2:113,rankName2:'年排'},
                        {scoreName:'化学',scoreValue:73,rankValue:13,rankName:'班排',rankValue2:159,rankName2:'年排'},
                        {scoreName:'化学赋分',scoreValue:73,rankValue:13,rankName:'班排',rankValue2:159,rankName2:'年排'},
                        {scoreName:'生物',scoreValue:91,rankValue:1,rankName:'班排',rankValue2:12,rankName2:'年排'},
                        {scoreName:'生物赋分',scoreValue:91,rankValue:1,rankName:'班排',rankValue2:12,rankName2:'年排'},
                    ]
                },

                {name:'高一上学期期末考',
                    scoreList:[
                        {scoreName:'总赋分',scoreValue:630,rankValue:1,rankName:'班排',rankValue2:23,rankName2:'年排'},
                        {scoreName:'总分',scoreValue:630,rankValue:1,rankName:'班排',rankValue2:23,rankName2:'年排'},
                        {scoreName:'语文',scoreValue:115,rankValue:5,rankName:'班排',rankValue2:41,rankName2:'年排'},
                        {scoreName:'数学',scoreValue:118,rankValue:7,rankName:'班排',rankValue2:101,rankName2:'年排'},
                        {scoreName:'英语',scoreValue:138,rankValue:6,rankName:'班排',rankValue2:19,rankName2:'年排'},
                        {scoreName:'物理',scoreValue:83,rankValue:10,rankName:'班排',rankValue2:105,rankName2:'年排'},
                        {scoreName:'化学',scoreValue:90,rankValue:7,rankName:'班排',rankValue2:114,rankName2:'年排'},
                        {scoreName:'化学赋分',scoreValue:90,rankValue:7,rankName:'班排',rankValue2:114,rankName2:'年排'},
                        {scoreName:'生物',scoreValue:86,rankValue:12,rankName:'班排',rankValue2:225,rankName2:'年排'},
                        {scoreName:'生物赋分',scoreValue:86,rankValue:12,rankName:'班排',rankValue2:225,rankName2:'年排'},
                    ]
                },
                {name:'高一下学期3月月考',
                    scoreList:[
                        {scoreName:'总赋分',scoreValue:611,rankValue:2,rankName:'班排',rankValue2:17,rankName2:'年排'},
                        {scoreName:'总分',scoreValue:589,rankValue:2,rankName:'班排',rankValue2:18,rankName2:'年排'},
                        {scoreName:'语文',scoreValue:92,rankValue:32,rankName:'班排',rankValue2:435,rankName2:'年排'},
                        {scoreName:'数学',scoreValue:137,rankValue:3,rankName:'班排',rankValue2:30,rankName2:'年排'},
                        {scoreName:'英语',scoreValue:120,rankValue:4,rankName:'班排',rankValue2:34,rankName2:'年排'},
                        {scoreName:'物理',scoreValue:93,rankValue:1,rankName:'班排',rankValue2:5,rankName2:'年排'},
                        {scoreName:'化学',scoreValue:76,rankValue:9,rankName:'班排',rankValue2:148,rankName2:'年排'},
                        {scoreName:'化学赋分',scoreValue:83,rankValue:9,rankName:'班排',rankValue2:148,rankName2:'年排'},
                        {scoreName:'生物',scoreValue:71,rankValue:2,rankName:'班排',rankValue2:75,rankName2:'年排'},
                        {scoreName:'生物赋分',scoreValue:86,rankValue:2,rankName:'班排',rankValue2:75,rankName2:'年排'},
                    ]
                },
                {name:'高一下学期半期考',
                    scoreList:[
                        {scoreName:'总赋分',scoreValue:586,rankValue:4,rankName:'班排',rankValue2:77,rankName2:'年排'},
                        {scoreName:'总分',scoreValue:550,rankValue:4,rankName:'班排',rankValue2:128,rankName2:'年排'},
                        {scoreName:'语文',scoreValue:105,rankValue:3,rankName:'班排',rankValue2:95,rankName2:'年排'},
                        {scoreName:'数学',scoreValue:125,rankValue:4,rankName:'班排',rankValue2:61,rankName2:'年排'},
                        {scoreName:'英语',scoreValue:126,rankValue:2,rankName:'班排',rankValue2:4,rankName2:'年排'},
                        {scoreName:'物理',scoreValue:68,rankValue:21,rankName:'班排',rankValue2:258,rankName2:'年排'},
                        {scoreName:'化学',scoreValue:62,rankValue:18,rankName:'班排',rankValue2:280,rankName2:'年排'},
                        {scoreName:'化学赋分',scoreValue:80,rankValue:18,rankName:'班排',rankValue2:280,rankName2:'年排'},
                        {scoreName:'生物',scoreValue:64,rankValue:7,rankName:'班排',rankValue2:192,rankName2:'年排'},
                        {scoreName:'生物赋分',scoreValue:82,rankValue:7,rankName:'班排',rankValue2:192,rankName2:'年排'},
                    ]
                },
                {name:'高一下学习6月月考',
                    scoreList:[
                        {scoreName:'总赋分',scoreValue:591,rankValue:1,rankName:'班排',rankValue2:31,rankName2:'年排'},
                        {scoreName:'总分',scoreValue:555,rankValue:1,rankName:'班排',rankValue2:40,rankName2:'年排'},
                        {scoreName:'语文',scoreValue:106,rankValue:4,rankName:'班排',rankValue2:121,rankName2:'年排'},
                        {scoreName:'数学',scoreValue:103,rankValue:9,rankName:'班排',rankValue2:139,rankName2:'年排'},
                        {scoreName:'英语',scoreValue:117,rankValue:9,rankName:'班排',rankValue2:69,rankName2:'年排'},
                        {scoreName:'物理',scoreValue:89,rankValue:1,rankName:'班排',rankValue2:2,rankName2:'年排'},
                        {scoreName:'化学',scoreValue:71,rankValue:3,rankName:'班排',rankValue2:59,rankName2:'年排'},
                        {scoreName:'化学赋分',scoreValue:91,rankValue:3,rankName:'班排',rankValue2:59,rankName2:'年排'},
                        {scoreName:'生物',scoreValue:69,rankValue:5,rankName:'班排',rankValue2:159,rankName2:'年排'},
                        {scoreName:'生物赋分',scoreValue:85,rankValue:5,rankName:'班排',rankValue2:159,rankName2:'年排'},
                    ]
                },
                {name:'高一下学期期末考',
                    scoreList:[
                        {scoreName:'总赋分',scoreValue:601,rankValue:4,rankName:'班排',rankValue2:67,rankName2:'年排'},
                        {scoreName:'总分',scoreValue:575,rankValue:5,rankName:'班排',rankValue2:88,rankName2:'年排'},
                        {scoreName:'语文',scoreValue:114,rankValue:3,rankName:'班排',rankValue2:42,rankName2:'年排'},
                        {scoreName:'数学',scoreValue:126,rankValue:7,rankName:'班排',rankValue2:89,rankName2:'年排'},
                        {scoreName:'英语',scoreValue:122,rankValue:3,rankName:'班排',rankValue2:34,rankName2:'年排'},
                        {scoreName:'物理',scoreValue:78,rankValue:9,rankName:'班排',rankValue2:152,rankName2:'年排'},
                        {scoreName:'化学',scoreValue:68,rankValue:13,rankName:'班排',rankValue2:187,rankName2:'年排'},
                        {scoreName:'化学赋分',scoreValue:86,rankValue:13,rankName:'班排',rankValue2:187,rankName2:'年排'},
                        {scoreName:'生物',scoreValue:67,rankValue:20,rankName:'班排',rankValue2:283,rankName2:'年排'},
                        {scoreName:'生物赋分',scoreValue:75,rankValue:20,rankName:'班排',rankValue2:283,rankName2:'年排'},
                    ]
                },

                {name:'高二上学习10月月考',
                    scoreList:[
                        {scoreName:'总赋分',scoreValue:596,rankValue:6,rankName:'班排',rankValue2:83,rankName2:'年排'},
                        {scoreName:'总分',scoreValue:564.5,rankValue:6,rankName:'班排',rankValue2:83,rankName2:'年排'},
                        {scoreName:'语文',scoreValue:103,rankValue:17,rankName:'班排',rankValue2:250,rankName2:'年排'},
                        {scoreName:'数学',scoreValue:133,rankValue:7,rankName:'班排',rankValue2:108,rankName2:'年排'},
                        {scoreName:'英语',scoreValue:118.5,rankValue:3,rankName:'班排',rankValue2:35,rankName2:'年排'},
                        {scoreName:'物理',scoreValue:75,rankValue:9,rankName:'班排',rankValue2:170,rankName2:'年排'},
                        {scoreName:'化学',scoreValue:71,rankValue:1,rankName:'班排',rankValue2:55,rankName2:'年排'},
                        {scoreName:'化学赋分',scoreValue:92,rankValue:1,rankName:'班排',rankValue2:55,rankName2:'年排'},
                        {scoreName:'生物',scoreValue:64,rankValue:21,rankName:'班排',rankValue2:274,rankName2:'年排'},
                        {scoreName:'生物赋分',scoreValue:74,rankValue:21,rankName:'班排',rankValue2:274,rankName2:'年排'},
                    ]
                },
            ],

            //value1:分数  value2:人数   value3:累计人数
            dataList2:[{nd:2024,
                        scoreList: [{value1:'699-750', value2:'51', value3:'51'},
                                    {value1:'698', value2:'12', value3:'63'},
                                    {value1:'697', value2:'14', value3:'77'},
                                   ]},
                {nd:2023,
                    scoreList: [{value1:'699-750', value2:'41', value3:'41'},
                        {value1:'698', value2:'12', value3:'63'},
                        {value1:'697', value2:'14', value3:'77'},
                    ]},
                {nd:2022,
                    scoreList: [{value1:'699-750', value2:'31', value3:'31'},
                        {value1:'698', value2:'12', value3:'63'},
                        {value1:'697', value2:'14', value3:'77'},
                    ]},
            ],

            //nd:年度 schoolName:学校名称 schoolNO:学校编号  value1:批次  value2:科类  value3:专业  bz:备注 number:人数 minScore:最低分 minLevel:最低分位次
            dataList3:[
                {nd:2024,
                    schoolList:[{schoolName:'北京大学',schoolNO:'0001', value1:'本科批B段', value2:'理科', value3:'理科试验班类', bz:'原本科一批新选科物理,化学(元培)(包含专业:数学类)', number:1, minScore:699, minLevel:63},
                        {schoolName:'北京大学',schoolNO:'0001', value1:'本科批B段', value2:'理科', value3:'化学类', bz:'原本科一批新选科物理,化学(包含专业:化学、应用化学、应用化学(材料方向)、化学生物学)', number:1, minScore:709, minLevel:63},
                        {schoolName:'北京大学',schoolNO:'0001', value1:'本科批B段', value2:'理科', value3:'生物科学类', bz:'原本科一批新选科不提科目要求', number:1, minScore:705, minLevel:63},
                    ],},
                {nd:2023,
                    schoolList:[{schoolName:'北京大学',schoolNO:'0001', value1:'本科批B段', value2:'理科', value3:'心理学类', bz:'原本科一批新选科物理,化学(元培)(包含专业:数学类)', number:1, minScore:699, minLevel:63},
                        {schoolName:'北京大学',schoolNO:'0001', value1:'本科批B段', value2:'理科', value3:'经济学类', bz:'原本科一批新选科物理,化学(包含专业:化学、应用化学、应用化学(材料方向)、化学生物学)', number:1, minScore:709, minLevel:63},
                        {schoolName:'北京大学',schoolNO:'0001', value1:'本科批B段', value2:'理科', value3:'工商管理类', bz:'原本科一批新选科不提科目要求', number:1, minScore:705, minLevel:63},
                        ],},


            ],
        }

        // 更新图表函数
        function updateChart(subject, button) {
            p_type1 = subject;

            // 移除所有按钮的 active 类
            document.querySelectorAll('.button-group button').forEach(btn => {
                btn.classList.remove('active');
            });
            // 为当前按钮添加 active 类
            button.classList.add('active');
            //更新图表
            intEcharts(p_type1, p_type2, '')
        }

        // 班排、年排 按钮
        function showRank(subject, button) {
            p_type2 = subject
            // 移除所有按钮的 active 类
            document.querySelectorAll('.rank-buttons button').forEach(btn => {
                btn.classList.remove('active');
            });
            // 为当前按钮添加 active 类
            button.classList.add('active');

            //更新图表
            intEcharts(p_type1, p_type2, '')
        }
        function clearCharts(){
            var chartDom = document.getElementById('chart');
            var myChart = echarts.init(chartDom);
            myChart.clear();
        }

        //初始化目按钮
        function intBtnGroup(){
            //加载科目按钮
            var  dataList2 = dataMap.dataList1[0].scoreList.map(item => item.scoreName);
            var htmlStr = '';
            dataList2.forEach((item,index) => {
                if(index===0){
                    htmlStr +='<button onclick="updateChart(\'' + item + '\', this)" class="active">'+item+'</button>'
                }else{
                    htmlStr +='<button onclick="updateChart(\'' + item + '\', this)">'+item+'</button>'
                }
            });

            // 获取 class 为 btngroup 的 div 元素
            const btnGroup = document.querySelector('.button-group');
            // 如果元素存在，则将 HTML 字符串加载进去
            if (btnGroup) {
                btnGroup.innerHTML = htmlStr;
            } else {
                console.warn('未找到 class 为 btngroup 的元素');
            }
        }

        // 初始化图表 type1：科目; type2：班排或年排
        function intEcharts(type1, type2, score) {
            clearCharts()

            //加载图表
            var chartDom = document.getElementById('chart');
            var myChart = echarts.init(chartDom);

            var data1 = dataMap.dataList1.map(item => item.scoreList.find(s => s.scoreName === type1).scoreValue)
            var maxValue = Math.max(...data1);
            var minValue =  Math.min(...data1);
            if (score?score:0 > maxValue){
                maxValue = parseFloat(score);
            }
            /*if (score?score:10000 < minValue){
                minValue = parseFloat(score);
            }*/

            var data2 = dataMap.dataList1.map(item => {
                const scoreItem = item.scoreList.find(s => s.scoreName === type1);
                return type2==='班排'?scoreItem.rankValue:scoreItem.rankValue2;
            })

            // 初始化图表
            var option = {
                legend: {
                    data: ['成绩', type2],
                    top: 'top',
                    padding: [0, 0]
                },
                xAxis: {
                    type: 'category',
                    data: dataMap.dataList1.map(item => item.name),
                    axisLine: {
                        show: false, // 不显示坐标轴线
                    },
                    scrollbar: { // 开启滚动条
                        show: true,
                    },
                    axisLabel: {
                        formatter: function(value) {
                            var str = '';
                            if(value.length >= 3){
                                str = value.substring(0, 3) + '\n' + value.substring(3, 8)+ '\n' + value.substring(8, value.length);
                            }

                            return str; // 按需格式化并换行
                        },
                        margin: 10, // 可能需要调整标签之间的间距以适应换行
                        fontSize: 8,
                    },
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '',
                        position: 'left',
                        axisLabel: {
                            fontSize: 8,
                            formatter: '{value} 分'
                        },
                        index: 1,
                        min: minValue - minValue * 0.1,
                        max: maxValue + maxValue * 0.1,
                    },
                    {
                        type: 'value',
                        name: '',
                        position: 'right',
                        inverse: true,
                        axisLabel: {
                            fontSize: 8,
                            formatter: '{value} 名'
                        },
                        index: 0,
                        min: 1
                    }
                ],
                series: [
                    {
                        name: '成绩',
                        type: 'line',
                        barWidth: '30%',
                        data: data1,
                        z: 2,
                        markLine: {
                            silent: true, // 不触发事件
                            data: [{
                                yAxis: score, // 最低录取分数
                                name: '最低录取分数',
                                label: {
                                    formatter: '最低录取分数: {c}', // 显示目标分数线数值
                                    position: 'middle' // 标签位置
                                },
                                lineStyle: {
                                    color: '#16d602', // 目标分数线颜色
                                    width: 2, // 线宽
                                    type: 'dashed' // 线型（虚线）
                                }
                            }],

                        },
                        itemStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [
                                    { offset: 0, color: '#83bff6' },
                                    { offset: 0.5, color: '#188df0' },
                                    { offset: 1, color: '#0052d9' }
                                ]
                            }
                        },
                        label: {
                            show: true,
                            position: 'top',
                            offset: [0, -24],
                            textStyle: {
                                color: '#3a3636',
                                fontSize: 8,
                            },
                            formatter: function(params) {
                                const item = dataMap.dataList1[params.dataIndex];
                                const scoreItem = item.scoreList.find(s => s.scoreName === type1);
                                return `${scoreItem.scoreValue} \n班: ${scoreItem.rankValue} \n年: ${scoreItem.rankValue2}`;
                            }
                        }
                    },
                    {
                        name: type2,
                        type: 'line',
                        yAxisIndex: 1,
                        data: data2,
                        symbol: 'circle',
                        symbolSize: 8,
                        z: 1,
                        itemStyle: {
                            color: '#FF0000'
                        },
                        lineStyle: {
                            width: 3
                        }
                    },

                ]
            };
            myChart.setOption(option);
            
        }

        function showTab(tabId) {
            // 隐藏所有 tab 内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // 移除所有按钮的 active 类
            document.querySelectorAll('.tab-buttons button').forEach(btn => {
                btn.classList.remove('active');
            });
            // 显示当前 tab 内容
            document.getElementById(tabId).classList.add('active');
            // 为当前按钮添加 active 类
            event.target.classList.add('active');
        }

        function fillTab1Data() {
            // 1. 提取 dataList2 中的 nd 字段，生成年度按钮组
            const ndBtnGroup = document.querySelector('.ndBtnGroup1');
            if (!ndBtnGroup) {
                console.error('找不到 class 为 "ndBtnGroup" 的 div');
                return;
            }

            // 清空按钮组
            ndBtnGroup.innerHTML = '';

            // 提取所有年度
            const ndList = dataMap.dataList2.map(item => item.nd);
            if (ndList.length === 0) {
                console.error('dataList2 中没有数据');
                return;
            }

            // 生成年度按钮
            ndList.forEach((nd, index) => {
                const button = document.createElement('button');
                button.textContent = nd;
                button.dataset.nd = nd;

                // 默认选中第一个按钮
                if (index === 0) {
                    button.classList.add('active');
                    // 加载第一个年度的数据到 table1
                    loadTable1Data(dataMap.dataList2[0].scoreList);
                }

                // 按钮点击事件
                button.addEventListener('click', function() {
                    // 移除所有按钮的 active 类
                    document.querySelectorAll('.ndBtnGroup1 button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    // 添加当前按钮的 active 类
                    this.classList.add('active');

                    // 根据年度加载数据
                    const selectedNd = this.dataset.nd;
                    const selectedData = dataMap.dataList2.find(item => item.nd == selectedNd);
                    if (selectedData) {
                        loadTable1Data(selectedData.scoreList);
                    }
                });

                ndBtnGroup.appendChild(button);
            });

            // 隐藏等待提示动效
            hidLoading()
        }
        var p_nd2;
        function fillTab2Data() {
            // 1. 提取 dataList2 中的 nd 字段，生成年度按钮组
            const ndBtnGroup = document.querySelector('.ndBtnGroup2');
            if (!ndBtnGroup) {
                console.error('找不到 class 为 "ndBtnGroup" 的 div');
                return;
            }

            // 清空按钮组
            ndBtnGroup.innerHTML = '';

            // 提取所有年度
            const ndList = dataMap.dataList3.map(item => item.nd);
            if (ndList.length === 0) {
                console.error('dataList2 中没有数据');
                return;
            }


            // 生成年度按钮
            ndList.forEach((nd, index) => {
                const button = document.createElement('button');
                button.textContent = nd;
                button.dataset.nd = nd;

                // 默认选中第一个按钮
                if (index === 0) {
                    button.classList.add('active');
                    // 加载第一个年度的数据到 table1
                    loadTable2Data(dataMap.dataList3[0].schoolList);
                    p_nd2 = dataMap.dataList3[0].nd;
                }

                // 按钮点击事件
                button.addEventListener('click', function() {
                    // 移除所有按钮的 active 类
                    document.querySelectorAll('.ndBtnGroup2 button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    // 添加当前按钮的 active 类
                    this.classList.add('active');

                    // 根据年度加载数据
                    p_nd2 = this.dataset.nd;
                    const selectedNd = this.dataset.nd;
                    const selectedData = dataMap.dataList3.find(item => item.nd == selectedNd);
                    if (selectedData) {

                        // 显示等待提示动效
                        const loadingIndicator = document.getElementById('loadingIndicator');
                        loadingIndicator.style.display = 'block';

                        loadTable2Data(selectedData.schoolList);


                        // 隐藏等待提示动效
                        loadingIndicator.style.display = 'none';
                    }
                });

                ndBtnGroup.appendChild(button);
            });

            // 隐藏等待提示动效
            hidLoading()
        }
        // 加载数据到 table1
        function loadTable1Data(scoreList) {
            const table1 = document.getElementById('table1');
            if (!table1) {
                console.error('找不到 id 为 "table1" 的表格');
                return;
            }

            // 清空表格内容（保留表头）
            const tbody = table1.querySelector('.tbody1');
            if (tbody) {
                tbody.innerHTML = '';
            } else {
                console.error('找不到 table1 的 tbody');
                return;
            }
            //只显示前1000个
            var newscoreList = scoreList.filter((score,index) => {
                return index < 1000;
            })
            // 加载数据到表格
            newscoreList.forEach((score, index) => {
                const row = document.createElement('tr');
                if(index % 2 == 0){
                    row.style.backgroundColor = '#c1c1c1'
                }
                row.innerHTML = `
                                <td>${score.value1}</td>
                                <td>${score.value2}</td>
                                <td>${score.value3}</td>
                                `;
                tbody.appendChild(row);
            });
        }
        // 加载数据到 table2
        function loadTable2Data(schoolList) {
            const table2 = document.getElementById('table2');
            if (!table2) {
                console.error('找不到 id 为 "table1" 的表格');
                return;
            }

            // 清空表格内容（保留表头）
            const tbody = table2.querySelector('.tbody2');
            if (tbody) {
                tbody.innerHTML = '';
            } else {
                console.error('找不到 table1 的 tbody');
                return;
            }
            /*schoolList.sort((a,b) => {
                return b.minScore - a.minScore;
            })*/
            //只显示前1000个
            var newschoolList = schoolList.filter((school,index) => {
                return index < 200;
            })
            // 加载数据到表格
            newschoolList.forEach((school, index) => {
                const row = document.createElement('tr');
                if(index % 2 == 0){
                    row.style.backgroundColor = '#c1c1c1'
                }
                //nd:年度 schoolName:学校名称 schoolNO:学校编号  value1:批次  value2:科类  value3:专业  bz:备注 number:人数 minScore:最低分 minLevel:最低分位次

                row.innerHTML = `
                                <td> <a href="https://cn.bing.com/search?q=${school.schoolName} ${school.value3}" target="_blank" rel="noopener noreferrer">${school.schoolName}</a></td>
                                <td>${school.schoolNO}</td>
                                <td style="cursor: pointer" title="点击" onclick="showAIask('${school.schoolName}', '${school.schoolNO}','${school.value1}','${school.value2}','${school.value3}','${school.number}','${school.minScore}')">${school.value3} ☝</td>
                                <td>${school.number}</td>
                                <td style="cursor: pointer" title="点击" onclick="showDetail('${school.minScore}')">${school.minScore} ☝</td>
                                <td>${school.minLevel}</td>
                                `;
                tbody.appendChild(row);
            });

        }
        //在成绩图标中加入目标线
        function showDetail(score) {
            intEcharts(p_type1, p_type2, score);
            window.scrollTo({
                top: 0, // 滚动到页面顶部
                behavior: 'smooth' // 平滑滚动效果
            });
        }

        function showLoading() {
            // 显示等待提示动效
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';
        }
        function hidLoading() {
            // 显示等待提示动效
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'none';
        }
        //nd:年度 schoolName:学校名称 schoolNO:学校编号  value1:批次  value2:科类  value3:专业  bz:备注 number:人数 minScore:最低分 minLevel:最低分位次

        function showAIask(schoolName,schoolNO,value1,value2,value3,number,minScore) {

            /*const result = dataMap.dataList1.map(item => {
                // 找到 scoreName 为 '总赋分' 的 scoreValue
                const totalScore = item.scoreList.find(score => score.scoreName === '总赋分')?.scoreValue;
                return {
                    name: item.name,
                    scoreValue: totalScore
                };
            });
            result.forEach((item) => {
                contentstr += item.name + ' ' + item.scoreValue + '分;';
            })*/
            var scoreString = '';
            // 遍历 dataList1
            dataMap.dataList1.forEach(item => {
                // 提取总赋分
                const totalScore = item.scoreList.find(score => score.scoreName === "总赋分")?.scoreValue || "无数据";

                // 提取其他科目分数
                const subjectScores = item.scoreList
                    .filter(score => (score.scoreName !== "总赋分" && score.scoreName !== "总分" && score.scoreName !== "化学" && score.scoreName !== "生物"))
                    .map(score => `${score.scoreName}${score.scoreValue}分`)
                    .join("，");

                // 拼接字符串
                scoreString += `${item.name}总分 ${totalScore}分，${subjectScores}`;

            });

            //日期
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;


            // 获取输入框元素
            const userInput = document.getElementById('user-input');
            // 写入内容
            var contentstr = '你是一个高考AI，现在需要你根据以下信息，给出一个合理的建议。';
            contentstr += '现在是'+ formattedDate +'，学生'+p_studentName+'的平时考试成绩数据分别为：' + scoreString+ '。';
            contentstr += '学生'+p_studentName+'在2027年参加高考，想报考' + schoolName + ' 学校编码' + schoolNO + ' 录取批次' + value1 + ' 科类' + value2 + ' 专业' + value3 + '，';
            contentstr += '在 '+p_nd2 + '年'+schoolName + ' 学校编码' + schoolNO + ' 录取批次' + value1 + ' 科类' + value2 + ' 专业' + value3 + ' 在四川省录取人数为' + number + '人 最低录取分数' + minScore + '分。';
            contentstr += '请先介绍一下这个学校和这个专业的情况以及就业方向和就业情况，然后给出一个合理的建议。';

            userInput.value = contentstr;
            // 可选：触发输入事件（如果需要）
            // userInput.dispatchEvent(new Event('input'));
            document.getElementById('deepseek-chat').style.zIndex = '1';
            document.getElementById('deepseek-chat').style.opacity = '1';
        }
        function closeAIask() {
            document.getElementById('deepseek-chat').style.zIndex = '-1';
            document.getElementById('deepseek-chat').style.opacity = '0';


            document.getElementById('chat-messages').innerHTML = ''
            document.getElementById('user-input').value = ''
            chatHistory = []
        }
    </script>
</body>
</html>